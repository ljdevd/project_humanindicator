<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>Human indicator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        h1 {
            text-align: center;
        }
        #chart {
            width: 100%;
            height: 600px;
            margin: auto;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>NQ vs Human indicator</h1>
    <div class="controls">
        <button id="toggleStock">Toggle Stock Price</button>
        <button id="toggleSentiment">Toggle Positive Ratio</button>
        <button id="toggleMA7">Toggle 7-Day Moving Average</button>
    </div>
    <div id="chart"></div>

    <script>
        // 이동 평균 계산 함수
        function movingAverage(data, window_size) {
            let averages = [];
            for (let i = 0; i < data.length; i++) {
                if (i < window_size - 1) {
                    averages.push(null);
                    continue;
                }
                let window = data.slice(i - window_size + 1, i + 1);
                let sum = window.reduce((acc, val) => acc + val, 0);
                averages.push(sum / window_size);
            }
            return averages;
        }

        let visibility = [true, true, true]; // 트레이스 가시성 상태
        let stockTrace, sentimentTrace, MA7Trace;

        // Fetch stock data
        fetch('/api/data')
            .then(response => response.json())
            .then(stockData => {
                const stockDates = stockData.map(d => d.Date);
                const stockCloses = stockData.map(d => d.Close);

                // Fetch sentiment data
                fetch('/api/sentiment-data')
                    .then(response => response.json())
                    .then(sentimentData => {
                        sentimentData.sort((a, b) => new Date(a.date) - new Date(b.date));

                        const sentimentDates = sentimentData.map(d => d.date);
                        const PositiveRatio = sentimentData.map(d => d.positive_ratio);
                        const topWordsWithTitles = sentimentData.map(d => d.strongest_title_with_top_word);

                        const MA7 = movingAverage(PositiveRatio, 7);

                        // Create traces
                        stockTrace = {
                            x: stockDates,
                            y: stockCloses,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Stock Close Price',
                            line: { color: 'blue' },
                            yaxis: 'y1'
                        };

                        sentimentTrace = {
                            x: sentimentDates,
                            y: PositiveRatio,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Positive Ratio',
                            line: { color: 'orange' },
                            yaxis: 'y2',
                            text: topWordsWithTitles,
                            hovertemplate: `
                                <b>Positive Ratio</b><br>
                                Date: %{x}<br>
                                Ratio: %{y}%<br>
                                Top Word & Title: %{text}<extra></extra>
                            `,
                            hoverlabel: {
                                bgcolor: 'white',
                                font: {
                                    size: 14,
                                    color: 'black'
                                }
                            }
                        };

                        MA7Trace = {
                            x: sentimentDates,
                            y: MA7,
                            type: 'scatter',
                            mode: 'lines',
                            name: '7-Day Moving Average',
                            line: { color: 'green', dash: 'dash' },
                            yaxis: 'y2'
                        };

                        const layout = {
                            title: 'NQ vs Sentiment Analysis',
                            xaxis: { title: 'Date/Time' },
                            yaxis: {
                                title: 'Stock Close Price',
                                titlefont: { color: 'blue' },
                                tickfont: { color: 'blue' }
                            },
                            yaxis2: {
                                title: 'Positive Ratio',
                                titlefont: { color: 'orange' },
                                tickfont: { color: 'orange' },
                                overlaying: 'y',
                                side: 'right'
                            },
                            legend: { orientation: 'h' },
                            hovermode: 'x unified'
                        };

                        Plotly.newPlot('chart', [stockTrace, sentimentTrace, MA7Trace], layout);

                        // Add toggle functionality
                        document.getElementById('toggleStock').addEventListener('click', () => toggleTrace(0));
                        document.getElementById('toggleSentiment').addEventListener('click', () => toggleTrace(1));
                        document.getElementById('toggleMA7').addEventListener('click', () => toggleTrace(2));
                    })
                    .catch(error => console.error('Error fetching sentiment data:', error));
            })
            .catch(error => console.error('Error fetching stock data:', error));

        // Trace 토글 함수
        function toggleTrace(traceIndex) {
            visibility[traceIndex] = !visibility[traceIndex]; // 상태 토글
            Plotly.restyle('chart', { visible: visibility[traceIndex] ? true : 'legendonly' }, [traceIndex]);
        }
    </script>
</body>
</html>
