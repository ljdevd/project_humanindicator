<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Human Indicator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        #chart-container {
            width: 100%;
            max-width: 800px;
            margin: auto;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls select {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        .controls select:focus {
            outline: none;
            border-color: #007BFF;
        }
    </style>
</head>
<body>
    <h1>NQ vs Human Indicator</h1>
    <div class="controls">
        <select id="toggleSelect" onchange="toggleFromDropdown(this.value)">
            <option value="stockPrice" selected>Toggle Stock Price</option>
            <option value="positiveRatio">Toggle Positive Ratio</option>
            <option value="movingAverage">Toggle 7-Day Moving Average</option>
        </select>
    </div>
    <div id="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let chart; // Chart.js 인스턴스

        // 차트를 초기화하는 함수
        function initializeChart(stockData, sentimentData) {
            const ctx = document.getElementById('myChart').getContext('2d');

            const stockDates = stockData.map(d => d.Date);
            const stockCloses = stockData.map(d => d.Close);
            const sentimentDates = sentimentData.map(d => d.date);
            const positiveRatio = sentimentData.map(d => d.positive_ratio);
            const movingAverage = calculateMovingAverage(positiveRatio, 7);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stockDates,
                    datasets: [
                        {
                            label: 'Stock Close Price',
                            data: stockCloses,
                            borderColor: 'blue',
                            backgroundColor: 'transparent',
                            hidden: false
                        },
                        {
                            label: 'Positive Ratio',
                            data: positiveRatio,
                            borderColor: 'orange',
                            backgroundColor: 'transparent',
                            hidden: false
                        },
                        {
                            label: '7-Day Moving Average',
                            data: movingAverage,
                            borderColor: 'green',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            hidden: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Values'
                            }
                        }
                    }
                }
            });
        }

        // 이동 평균 계산 함수
        function calculateMovingAverage(data, windowSize) {
            let averages = [];
            for (let i = 0; i < data.length; i++) {
                if (i < windowSize - 1) {
                    averages.push(null);
                } else {
                    const slice = data.slice(i - windowSize + 1, i + 1);
                    const sum = slice.reduce((acc, val) => acc + val, 0);
                    averages.push(sum / windowSize);
                }
            }
            return averages;
        }

        // 드롭다운 변경 시 호출되는 함수
        function toggleFromDropdown(datasetKey) {
            const datasetIndex = {
                stockPrice: 0,
                positiveRatio: 1,
                movingAverage: 2
            }[datasetKey];

            chart.data.datasets[datasetIndex].hidden = !chart.data.datasets[datasetIndex].hidden;
            chart.update();
        }

        // 데이터 로드 및 차트 초기화
        Promise.all([
            fetch('/api/data').then(res => res.json()),
            fetch('/api/sentiment-data').then(res => res.json())
        ]).then(([stockData, sentimentData]) => {
            initializeChart(stockData, sentimentData);
        }).catch(error => console.error('Error loading data:', error));
    </script>
</body>
</html>
